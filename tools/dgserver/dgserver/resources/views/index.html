<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=GBK" />
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache, must-revalidate">
    <meta http-equiv="Cache" content="no-cache">
    <title>屏幕设计器</title>
    <link rel="stylesheet" href="../resources/css/reset.css" />
    <link rel="stylesheet" href="../resources/bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="../resources/font-awesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="../resources/bootstrap/css/toastr.css" />
    <link rel="stylesheet" href="../resources/css/index.css" />
    <link rel="stylesheet" href="../resources/css/menu.css" />
    <link rel="stylesheet" href="../resources/css/spectrum.css" />
    <link rel="stylesheet" href="../resources/css/confirm-animate.css" />
    <link rel="stylesheet" href="../resources/css/folder.css" />
    <script src="../resources/js/jquery-1.9.1.min.js"></script>
    <script src="../resources/bootstrap/js/bootstrap.js"></script>
    <script src="../resources/bootstrap/js/toastr.js"></script>
    <script src="../resources/bootstrap/js/BootstrapMenu.min.js"></script>
    <script src="../System/Assembly.js"></script>
    <script src="../System/Net/WebSocketClient.js"></script>
    <script src="../resources/js/confirm.js"></script>
    <script src="../resources/js/main.js"></script>
    <script src="../resources/js/index.js"></script>
    <script src="../resources/js/HtmlControl.js"></script>
    <script src="../resources/js/spectrum.js"></script>
    <script src="../resources/js/upload.js"></script>
    <script src="../resources/js/dialog.js"></script>
    <script src="../resources/js/drag.js"></script>
    <script src="../resources/js/ListBox.js"></script>
    <script src="../resources/js/BroadcastBox.js"></script>
    <script src="../resources/js/VideoControl.js"></script>
    <script src="../resources/js/QueueInfo.js"></script>
    <script src="../resources/js/menu.js"></script>
    <!--<script src="../resources/js/vconsole.min.js"></script>-->
</head>
<body style="z-index:1" onContextMenu="return false" onSelectStart="return false">

    <div class="wrap">
        <div class="nav-top">
            <div class="toolbar-move logo"><img src="../resources/images/logo.png" />TECHMARS</div>
            <div class="btn-group mr20" data-toggle="buttons-checkbox" style="margin-left: 20px;">
                <button class="btn btn-primary upload"><span class="glyphicon glyphicon-arrow-up"></span>&ensp;上传</button>
                <button class="btn btn-primary dowload"><span class="glyphicon 	glyphicon glyphicon-edit"></span>&ensp;编辑</button>
                <button class="btn btn-primary preview"><span class="glyphicon glyphicon-eye-open"></span>&ensp;预览</button>
            </div>
            <div class="btn-group mr20" data-toggle="buttons-checkbox" style="margin-left: 20px;">
                <button class="btn btn-primary clear"><span class="glyphicon glyphicon-trash"></span>&ensp;清空</button>
                <button class="btn btn-primary revoke"><span class="glyphicon glyphicon-arrow-left"></span>&ensp;撤销</button>
            </div>
            <div class="btn-group mr20">
                <span>屏幕分辨率：</span>
                <select class="ScreenResolution">
                    <option>Responsive</option>  
                    <option value="800x480">640x480</option>
                    <option value="1024x600">1024x600</option>
                    <option value="1080x1920">1080x1920</option>
                    <option value="1280x800">1280x800</option>
                    <option value="1440x900">1440x900</option>
                    <option value="1680x1050">1680x1050</option>
                    <option value="1920x1200" selected>1920x1200</option>
                    <option value="2560x1600">2560x1600</option>
                    <option value="640x480">640x480</option>
                    <option value="800x600">800x600</option>
                    <option value="1024x768">1024x768</option>
                    <option value="1400x1050">1400x1050</option>
                    <option value="1600x1200">1600x1200</option>
                    <option value="2048x1536">2048x1536</option>
                    <option value="960x540">960x540</option>
                    <option value="1280x720">1280x720</option>
                    <option value="1366x768">1366x768</option>
                    <option value="2560x1440">2560x1440</option>
                    <option value="1280x1024">2560x1600</option>
                </select>
            </div>
            <div class="btn-group mr20 custom">
                <input type="text" name="width" disabled="disabled" value="1920" /> x <input type="text" name="height" disabled="disabled" value="1200" />
            </div>
        </div>
        <div class="page-content">
            <div class="nav vertical">
                <div class="left-title">工具栏</div>
                <div class="panel-group-wrap">
                    <div class="panel-group" id="accordion">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseOne">
                                        控件
                                    </a>
                                </h4>
                                
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse in ">
                                <div class="controls-list drag">
                                    <p class="ui-draggable HtmlControl" data-type="0">
                                        <i class="fa fa-window-maximize" aria-hidden="true"></i> &nbsp; HtmlControl<a href="##"><span class="glyphicon glyphicon-move"></span></a>
                                    </p>
                                    <p class="ui-draggable HtmlControl" data-type="0">
                                        <i class="fa fa-list" aria-hidden="true"></i> &nbsp; ListBox<a href="##"><span class="glyphicon glyphicon-move"></span></a>
                                    </p>
                                    <p class="ui-draggable HtmlControl" data-type="0">
                                        <i class="fa fa-play-circle-o" aria-hidden="true"></i> &nbsp; VideoControl<a href="##"><span class="glyphicon glyphicon-move"></span></a>
                                    </p>
                                    <p class="ui-draggable HtmlControl" data-type="0">
                                        <i class="fa fa-map-o" aria-hidden="true"></i> &nbsp; BroadcastBox<a href="##"><span class="glyphicon glyphicon-move"></span></a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseTwo">
                                        数据源
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseTwo" class="panel-collapse collapse drag">
                                <div class="data-source drag">
                                    <p class="QueueInfo" data-type="1"><i class="fa fa-database" aria-hidden="true"></i> &nbsp; QueueInfo<a href="##"></a></p>
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseThree">
                                        模板
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseThree" class="panel-collapse collapse drag">
                                <div class="template-source drag">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-15" style="position: absolute;bottom: 0;">
                    <div class="input-group">
                        <input type="text" id="LeftTemplateText" class="form-control">
                        <span class="input-group-btn">
                            <button id="LeftTemplateSearchBtn" class="btn btn-default" type="button">
                                <span class="glyphicon glyphicon-search"></span>
                            </button>
                        </span>
                    </div><!-- /input-group -->
                </div>
            </div>
            <div class="design-content">
                <div class="canvas-container">
                    <div id="canvas" class="drag"></div>
                </div>
            </div>
            <div class="directory">
                <ul class="right-title flex-box">
                    <li class="adapt active" data-type="0">属性</li>
                    <li class="adapt" data-type="1">数据源</li>
                </ul>
                <div class="table-wrap-data">
                    <div class="table_0">
                        <div class="view-type">
                            控件名：
                            <select class="choose-control"></select>
                        </div>
                        <div class="toolbar toolbar-table">
                            <table class="tool-table" border="1">
                                <thead>
                                    <tr>
                                        <th>属性</th>
                                        <th>值</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="table_1">
                        <div class="data-title"></div>
                        <div class="toolbar toolbar-table">
                            <table class="data-table" border="1">
                                <thead>
                                    <tr>
                                        <th>属性</th>
                                        <th>类型</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="introduce"></div>
            </div>
        </div>
    </div>
   
    <div class="modal fade" id="myModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="margin-top:100px">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        上传
                    </h4>
                </div>
                <form class="modal-body submit_form">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">所属分组：</label>
                        <div class="col-sm-7">
                            <select name="gcode" style="width: 100%;height: 34px;border-radius: 5px;padding-left: 10px;">
                                <option value='' disabled selected style='display:none;'>请选择模板</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">视图名称：</label>
                        <div class="col-sm-7">
                            <input type="text" name="viewname" class="form-control" placeholder="请输入视图名称">
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    <button type="button" class="btn btn-primary uploadsub">
                        上传
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div class="modal fade" id="PreviewModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="margin-top:100px">
        <div class="modal-dialog">
            <div class="modal-content ">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        编辑
                    </h4>
                </div>
                <form class="modal-body preview_form">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">所属分组：</label>
                        <div class="col-sm-7">
                            <select name="gcode" style="width: 100%;height: 34px;border-radius: 5px;padding-left: 10px;">
                                <option value='' disabled selected style='display:none;'>请选择模板</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">视图名称：</label>
                        <div class="col-sm-7">
                            <select name="querycode" style="width: 100%;height: 34px;border-radius: 5px;padding-left: 10px;">
                                <option value='' disabled selected style='display:none;'>请选择视图名称</option>
                            </select>
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    <button type="button" class="btn btn-primary EditSubmit">
                        编辑提交
                    </button>
                    <button type="button" class="btn btn-primary dowloadsub">
                        编辑
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div> 
</body>
</html>
<script>
    HtmlView.DesignMode = true;
    //var a = new VConsole();
    var canvas = $("#canvas");
    var View = view = HtmlView.New(canvas);
    var timer = null;

    view.Name = "HtmlView";

    var DataSources = [{
        "componentid": "QueueInfo",
        "codeurl": "QueueInfo.js",
        "name": "QueueInfo",
        "type": 0,
        "description": "控件的基类",
        "references": "../resources/js/QueueInfo.js",
        "inheritances": 'QueueInfo'
    }];

    //清空
    $(".clear").click(function () {
        ClearAllControls();
    });

    //预览
    $('.preview').click(function () {
        var controls = view.SuspendLayout();
        var con = JSON.stringify(controls);
        sessionStorage.setItem('con', con);
        window.open('preview.html?WSServer=192.168.100.254:5354&DepartId=1175380156');
    });
    function ClearAllControls() {
        var controls = HtmlDesigner.Control.GetAllControls();
        View.Dispose();
        View = view = HtmlView.New(canvas);
        if (controls.length) {
            for (var i = 0; i < controls.length; i++) {
                var control = controls[i];
                control.Dispose();
            }
        }
        drag.init.e('showHtmlView');
        drag.loadAllControls();
    }

    //获取模板分组
  
    function GetTempList() {
        xhr("/dg/views/GetAllGroupView", 'GET', null, function (res) {
            if (res.Tag && res.Tag.length) {
                LoadTempList(res.Tag);
            }
        });
    }
    xhr("/dg/group/loadgroup", 'GET', null, function (res) {
        if (res.Tag && res.Tag.length) {
            var list = res.Tag;
            var sel = $(".submit_form select[name=gcode]");
            for (var i = 0; i < list.length; i++) {
                sel.append('<option value=' + list[i].gcode + '>' + list[i].gname + '</option>');
            }
        }
    });

    //上传
    $(".upload").click(function () {
        $('#myModal').modal();
    });
    $(".dowload").click(function () {
        $('#PreviewModal').modal();
    });


    $('#LeftTemplateText')[0].oninput = function () {
        if (timer) {
            clearTimeout(timer);
        }

        timer = setTimeout(function () {
            SearchTemp();
        }, 500);
    };
    $("#LeftTemplateSearchBtn").click(SearchTemp);
    function SearchTemp() {
        var val = $("#LeftTemplateText").val();
        if (val == '') {
            $('.Left-template-subset').show();
            $('.Left-template').show();
            return;
        }
        $('.Left-template-subset').each(function () {
            if ($(this).html().indexOf(val) == -1) {
                $(this).hide();
            } else {
                $(this).show();
            }
        });
        $('.Left-template').each(function () {
            var index = $(this).attr('index');
            var temp = 0;
            $('.Left-template-subset[index="' + index + '"]').each(function () {
                if ($(this).css('display') != 'none') {
                    temp = 1;
                }
            });
            if (temp == 0) {
                $(this).hide();
            } else {
                $(this).show();
            }
        });
    }
    $('.uploadsub').click(function () {
        var form = $(".submit_form");
        var gcode = form.find('[name=gcode]').val().replace(/(^\s+)|(\s+$)/g, "");
        var viewname = form.find('[name=viewname]').val().replace(/(^\s+)|(\s+$)/g, "");
        if (!gcode.length) {
            alert("请选择长传的查询类别！");
            return;
        }
        if (!viewname.length) {
            alert("请输入视图名称！");
            return;
        }
        var param = {
            gcode: gcode,
            viewname: viewname
        };
        UpLoadPage(param);
    });
    $('.dowloadsub').click(function (){
        var form = $(".preview_form");
        var querycode = form.find('[name=querycode]').val().replace(/(^\s+)|(\s+$)/g, "");
        if (!querycode.length) {
            alert("请选择视图名称！");
            return;
        }
        querycode = querycode.split(',');
        var params = {
            code: querycode[0]
        };
        xhr('/dg/views/GetCode', 'GET', params, function (res) {
            if (res.Tag) {
                var tag = JSON.parse(res.Tag);
                LoadPreview(tag);
            } else {
                PromptBox('Tag内容无效！');
            }
        });
    });
    $(".EditSubmit").click(function () {
        var form = $(".preview_form");
        var gcode = form.find('[name=gcode]').val().replace(/(^\s+)|(\s+$)/g, "");
        var querycode = form.find('[name=querycode]').val().replace(/(^\s+)|(\s+$)/g, "");
        if (!gcode.length) {
            alert("请选择所属模板！");
            return;
        }
        if (!querycode.length) {
            alert("请选择视图名称！");
            return;
        }
        querycode = querycode.split(',');
        var params = {
            querycode: querycode[0],
            viewid: querycode[1],
            gcode: gcode,
            viewname: querycode[2]
        }
        UpLoadPage(params);
    });
    $('.revoke').click(function () {
        ViewsOperation.Revoke();
        //toastr.info("返回上一步");
        //var con = ViewsOperation.Revoke();
        //if(con){
        //   ClearAllControls();
        //   View.ResumeLayout(JSON.parse(con));
        //}
    });
    //选择分辨率
    $(".ScreenResolution").change(function () {
        var sel = $(this).val();
        if (sel == 'Responsive') {
            $('input[name=width]').removeAttr('disabled');
            $('input[name=height]').removeAttr('disabled');
            return;
        }
        var hybrid = sel.split("x");
        var w = hybrid[0], h = hybrid[1];
        $(".custom").find("input[name=width]").val(w).attr('disabled', true);
        $(".custom").find("input[name=height]").val(h).attr('disabled', true);
        $("#canvas").css({ 'width': w, 'height': h });
    });
    $(".custom").find("input").change(function () {
        var name = $(this).attr('name');
        var val = $(this).val();
        $('#canvas').css(name, val);
    });

    $(document).keydown(function (event) {
        event = event || window.event;
        if (event.keyCode === 46) { // del
            var control = drag.control;
            if (!__instanceof(control, HtmlControl)) {
                return false;
            }
            control.Dispose();
            drag.showHtmlView();
        }
    });
    $(document).ready(function () {
        drag.showHtmlView();
        //属性、数据源切换
        $('.right-title li').click(function () {
            var that = $(this);
            var lis = $('.right-title li');
            var activeLi = $('.right-title li.active');
            var type = that.attr("data-type");
            var nowType = activeLi.attr("data-type");

            if (type !== nowType) {
                lis.removeClass('active');
                that.addClass('active');
                $(".table_" + nowType).hide();
                $(".table_" + type).show();
            }
        });
        GetTempList();
        Combinatorialkey = new Combinatorialkey();
    });
    function UpLoadPage(params) {
        var layout = view.SuspendLayout();
        var size = {
            width: $('input[name=width]').val(),
            height: $('input[name=height]').val()
        };
        layout.size = size;
        params.viewcode = JSON.stringify(layout);
        xhr('/dg/views/addorupdate', 'POST', params, function (res) {
            PromptBox(res.Message);
        });
    }
    var Combinatorialkey = function () {
        var isPressCtrl = false;//是否按下ctrl
        this.ShearPlate = null;
        this.SelectControl = null;
        $(document).keydown(function (e) {
            if (e.keyCode === 17) {
                isPressCtrl = true;
                return;
            }
            if (isPressCtrl && e.keyCode === 67) {
                toastr.info("按下了ctrl 和 c键");
                var selc = Combinatorialkey.SelectControl;
                var com = {
                    "componentid": "HtmlControl",
                    "codeurl": "HtmlControl.js",
                    "type": 0,
                    "description": "控件的基类",
                    "references": "../resources/js/HtmlControl.js",
                    "inheritances": null
                };
                if (selc.GetType().FullName === 'ListBox') {
                    com.codeurl = 'ListBox.js';
                    com.componentid = 'ListBox';
                    com.references = '../resources/js/ListBox.js';
                    com.inheritances = 'ListBox';
                }

                var con = HtmlDesigner.Control.New(com);
                //var con = $(eval(rvoControl.Name)).data('.this');
                var type = con.GetType();
                var Properties = type.Properties;
                drag.showContor(selc.GetType().FullName, con);
                for (var i = 0; i < Properties.length; i++) {
                    var pro = Properties[i];
                    if (pro.Name === 'Items') {
                        var list = selc[pro.Name].GetAll();
                        for (var j = 0; j < list.length; j++) {
                            //con[pro.Name].Add(list[j]);
                            var item = new ListBoxItem(list[j]);
                            con[pro.Name].Add(item);
                            //dialog.AddList(list[j]);
                        }
                        continue;
                    }

                    if (pro.Writeable) {
                        if (pro.Name === 'Name')
                            continue;
                        var val = selc[pro.Name]();
                        if (pro.PropertyType === 'number') {
                            val = parseInt(val);
                        }
                        drag.setValue(con, pro.Name, val);
                    }
                }
                drag.LoadDelect(con);
                drag.LoadChangeSize(con);
            }
            if (isPressCtrl && e.keyCode === 88) {
                toastr.info("按下了ctrl 和 x键");
                Combinatorialkey.ShearPlate = Combinatorialkey.SelectControl;
                View.Controls.Remove(Combinatorialkey.SelectControl);
            }
            if (isPressCtrl && e.keyCode === 86) {
                toastr.info("按下了ctrl 和 v键");
                if (Combinatorialkey.ShearPlate) {
                    View.Controls.Add(Combinatorialkey.ShearPlate);
                } else {
                    toastr.info("没有剪切的控件");
                }
            }
            if (isPressCtrl && e.keyCode === 90) {
                toastr.info("按下了ctrl 和 z键");
                ViewsOperation.Revoke();
            }
        });
        $(document).keyup(function (e) {
            if (e.keyCode === 17) {
                isPressCtrl = false;
            }
        });
    };

    var LoadPreview = function (data) {
        ClearAllControls();
        View.ResumeLayout(data);

        if (data.size) {
            var sel = data.size.width + 'x' + data.size.height;
            $(".custom").find("input[name=width]").val(data.size.width).attr('disabled', true);
            $(".custom").find("input[name=height]").val(data.size.height).attr('disabled', true);
            if ($("option[value=" + sel + "]", ".ScreenResolution").length) {
                $('.ScreenResolution').val(sel);
            } else {
                $('.ScreenResolution').val('Responsive');
                $(".custom").find("input[name=width]").removeAttr('disabled');
                $(".custom").find("input[name=height]").removeAttr('disabled');
            }
        }

        var controls = data.View.Controls;
        for (var i = 0; i < controls.length; i++) {
            var name = controls[i].Name;
            var control = $(eval(name)).data(".this");
            drag.LoadDelect(control);
            drag.LoadChangeSize(control);
        }
    };
    var LoadTempList = function (list) {
        var sel = $(".preview_form select[name=gcode]");
        sel.empty();
        $('.template-source').empty();
        for (var i = 0; i < list.length; i++) {
            sel.append('<option value=' + list[i].gcode + '>' + list[i].gname + '</option>');


            var views = list[i].views;//模板加载
            if (views.length <= 0)
                continue;
            $('.template-source').append('<p class="Left-template" data-type="1" index="' + i + '">' + list[i].gname + '<span class="Left-template-number">(' + list[i].views.length + ')</span></p>');
            var subsetBox = '<div class="subsetBox' + i + '"></div>';
            $('.template-source').append(subsetBox);
            for (var j = 0; j < views.length; j++) {
                var view = views[j];
                $('.subsetBox' + i).append('<p class="Left-template-subset" data-type="1"  index="' + i + '" querycode="' + view.querycode + '" viewid="' + view.viewid + '">  ' + view.viewname + '</p>');
            }
            if (i > 0) {
                $('.subsetBox' + i).hide();
            }
        }
        $('.Left-template').on('click', function () {
            $('.subsetBox' + $(this).attr('index')).slideToggle();
        })
        sel.click(function () {
            var code = $(this).val();
            for (var i = 0; i < list.length; i++) {
                if (code == list[i].gcode) {
                    LoadTempCon(list[i].views);
                }
            }
        });
    };
   
    var LoadTempCon = function (list) {
        var sel = $("select[name=querycode]");
        sel.empty();
        if (list && list.length) {
            for (var i = 0; i < list.length; i++) {
                sel.append('<option value="' + list[i].querycode + ',' + list[i].viewid + ',' + list[i].viewname + '">' + list[i].viewname + '</option>');
            }
        }
    }
    var LoadTempNav = function () {
        var TempNav = $(".panel-group");
        for (var i = 0; i < list.length; i++) {
            var html = $([
                '<div class="panel panel-default">',
                '<div class="panel-heading">',
                '<h4 class="panel-title">',
                '<a data-toggle="collapse" data-parent="#accordion" href="#Temp' + list[i].gcode + '">',
                list[i].gname,
                ' </a></h4 ></div>',
                '<div id="collapseOne" class="panel-collapse collapse in">',
                '<div class="controls-list drag">',
                '</div></div>'
            ].join(''));
            TempNav.append(html);
        }
    };
    var PromptBox = function (txt) {
        method.msg_layer({
            title: "温馨提示",
            close: "true",
            content: txt,
            delay: 1500
        });
    };
</script>